<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: angularjs | Josep M Sobrepere]]></title>
  <link href="http://sobrepere.com/blog/categories/angularjs/atom.xml" rel="self"/>
  <link href="http://sobrepere.com/"/>
  <updated>2014-10-19T22:26:20-04:00</updated>
  <id>http://sobrepere.com/</id>
  <author>
    <name><![CDATA[Josep M Sobrepere]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Creating a 'groupBy' $filter in Angular]]></title>
    <link href="http://sobrepere.com/blog/2014/10/14/creating-groupby-filter-angularjs/"/>
    <updated>2014-10-14T01:00:56-04:00</updated>
    <id>http://sobrepere.com/blog/2014/10/14/creating-groupby-filter-angularjs</id>
    <content type="html"><![CDATA[<p>A few weeks ago I decided that I wanted to develop a &lsquo;groupBy&rsquo; <code>$filter</code>.
I knew that these kind of filters are tricky because they tend to generate
infinite loops in the <code>$diggest</code> cycle. However, I wanted to fully understand why
these kinds of <code>$filter</code>s run into this problem. I also wanted
to figure out the best solution to overcome this issue.</p>

<p>In this post I will explain all the steps that I took to develop this <code>$filter</code>,
the problems that I encountered, what I learned, along with the final implementation
of the <code>$filter</code>.</p>

<!-- more -->


<h2>The Goal</h2>

<p>I wanted my custom &lsquo;groupBy&rsquo; <code>$filter</code> to work like this:</p>

<ul>
<li>Given an <code>Array</code> of <code>Object</code>s like this one:</li>
</ul>


<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">$scope</span><span class="p">.</span><span class="nx">students</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">Josep</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span>  <span class="kr">class</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">A</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;},</span>
        <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">Carles</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kr">class</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">B</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;},</span>
        <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">Xavi</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span>   <span class="kr">class</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">A</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;},</span>
        <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">Pere</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span>   <span class="kr">class</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">B</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;},</span>
        <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">Adri</span><span class="err">Ã </span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span>  <span class="kr">class</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">C</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;}</span>
   <span class="p">];</span></code></pre></div></p>

<ul>
<li>I wanted to be able to do this:</li>
</ul>


<p><div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li</span> <span class="na">ng-repeat=</span><span class="s">&quot;(class, classStudents) in (students | groupBy: &#39;class&#39;)&quot;</span><span class="nt">&gt;</span>
        {{class}}
        <span class="nt">&lt;ul&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">ng-repeat=</span><span class="s">&quot;student in classStudents&quot;</span><span class="nt">&gt;</span>
                {{student.name}}
            <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span>


<span class="nt">&lt;p&gt;</span></code></pre></div></p>

<h2>First Naive Attempt</h2>

<p>First I wrote this <code>$filter</code>:</p>

<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">sbrpr</span><span class="p">.</span><span class="nx">filters</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;,</span> <span class="p">[])</span>
<span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">groupBy</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span> <span class="nx">key</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]])</span>
                <span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]]</span><span class="o">=</span><span class="p">[];</span>
            <span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]].</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">});</span></code></pre></div></p>

<p>When <a href="http://jsfiddle.net/xf7w9h12/1/">I tried it out</a> I realized that there were errors in the console.</p>

<h2>The Problem</h2>

<p>In order to troubleshoot those errors I wrote these unit tests:</p>

<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">groupBy</span> <span class="nx">filter</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">$filterProvider</span><span class="p">,</span> <span class="nx">$compile</span><span class="p">,</span> <span class="nx">$scope</span><span class="p">,</span> <span class="nx">$filter</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">module</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">sbrpr</span><span class="p">.</span><span class="nx">filters</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;);</span>
    <span class="nx">inject</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">$filter</span><span class="o">&lt;</span><span class="err">/em&gt;, &lt;em&gt;$rootScope&lt;/em&gt;, &lt;em&gt;$compile&lt;/em&gt;) {</span>
      <span class="nx">$filter</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">$filter</span><span class="o">&lt;</span><span class="err">/em&gt;;</span>
      <span class="nx">$compile</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">$compile</span><span class="o">&lt;</span><span class="err">/em&gt;;</span>
      <span class="nx">$scope</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">$rootScope</span><span class="o">&lt;</span><span class="err">/em&gt;;</span>
    <span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>   <span class="nx">jasmine</span><span class="p">.</span><span class="nx">addMatchers</span><span class="p">({</span>
        <span class="nx">toEqualData</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">angular</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">{</span>
            <span class="nx">compare</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">actual</span><span class="p">,</span> <span class="nx">expected</span><span class="p">){</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">expected</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span>
                <span class="nx">expected</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;;</span>
              <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
              <span class="nx">result</span><span class="p">.</span><span class="nx">pass</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">actual</span><span class="p">,</span> <span class="nx">expected</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">students</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Josep&#39;</span><span class="p">,</span>  <span class="kr">class</span><span class="o">:</span> <span class="s1">&#39;A&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Carles&#39;</span><span class="p">,</span> <span class="kr">class</span><span class="o">:</span> <span class="s1">&#39;B&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Xavi&#39;</span><span class="p">,</span>   <span class="kr">class</span><span class="o">:</span> <span class="s1">&#39;A&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Pere&#39;</span><span class="p">,</span>   <span class="kr">class</span><span class="o">:</span> <span class="s1">&#39;B&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;AdriÃ &#39;</span><span class="p">,</span>  <span class="kr">class</span><span class="o">:</span> <span class="s1">&#39;C&#39;</span><span class="p">}</span>
<span class="p">];</span>
<span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="nx">it</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">should</span> <span class="nx">group</span> <span class="nx">students</span> <span class="nx">by</span> <span class="kr">class</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">grouppedStudents</span> <span class="o">=</span> <span class="nx">$filter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">groupBy</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;)(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">students</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="kr">class</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;);</span>
    <span class="kd">var</span> <span class="nx">expectedResult</span> <span class="o">=</span> <span class="p">{</span>
      <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">A</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">Josep</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span>  <span class="kr">class</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">A</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;},</span>
        <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">Xavi</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span>   <span class="kr">class</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">A</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;}</span>
        <span class="p">],</span>
      <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">B</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">Carles</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kr">class</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">B</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;},</span>
        <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">Pere</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span>   <span class="kr">class</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">B</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;}</span>
        <span class="p">],</span>
      <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">C</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="nx">ID</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="nx">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">Adri</span><span class="err">Ã </span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span>  <span class="kr">class</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">C</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;}</span>
        <span class="p">],</span>
    <span class="p">};</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">grouppedStudents</span><span class="p">).</span><span class="nx">toEqualData</span><span class="p">(</span><span class="nx">expectedResult</span><span class="p">);</span>
  <span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="nx">it</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">should</span> <span class="nx">work</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">view</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{{</span><span class="nx">students</span> <span class="o">|</span> <span class="nx">groupBy</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="kr">class</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;}}</span><span class="o">&lt;</span><span class="err">/p&gt;&amp;rdquo;);</span>
    <span class="nx">$compile</span><span class="p">(</span><span class="nx">elem</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">$scope</span><span class="p">)).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toThrow</span><span class="p">();</span>
  <span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="nx">it</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">should</span> <span class="nx">work</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">view</span> <span class="nx">combined</span> <span class="kd">with</span> <span class="nx">ngRepeat</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span>
      <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;&amp;</span><span class="nx">rdquo</span><span class="p">;</span> <span class="o">+</span>
       <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="nx">li</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">repeat</span><span class="o">=</span><span class="err">\</span><span class="s2">&quot;(class, classStudents) in (students | groupBy: &#39;class&#39;)\&quot;&gt;&amp;rdquo; +</span>
<span class="s2">          &amp;ldquo;{{class}}&amp;rdquo; +</span>
<span class="s2">          &amp;ldquo;&lt;ul&gt;&amp;rdquo; +</span>
<span class="s2">            &amp;ldquo;&lt;li ng-repeat=\&quot;student in classStudents\&quot;</span><span class="o">&gt;&amp;</span><span class="nx">rdquo</span><span class="p">;</span> <span class="o">+</span>
              <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;{{</span><span class="nx">student</span><span class="p">.</span><span class="nx">name</span><span class="p">}}</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span> <span class="o">+</span>
            <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/li&gt;&amp;rdquo; +</span>
          <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/ul&gt;&amp;rdquo; +</span>
        <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/li&gt;&amp;rdquo; +</span>
      <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/ul&gt;&amp;rdquo;);</span>
    <span class="nx">$compile</span><span class="p">(</span><span class="nx">elem</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">$scope</span><span class="p">)).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toThrow</span><span class="p">();</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">children</span><span class="p">().</span><span class="nx">children</span><span class="p">().</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre></div></p>

<p><a href="http://plnkr.co/edit/22O4xbU0wweLCJws7qZC?p=preview">The results of these tests</a> provided interesting feedback:</p>

<ul>
<li>The <code>$filter</code> worked well when used in JavaScript</li>
<li>It also worked well when used inside a trivial HTML template</li>
<li>It triggered an <a href="https://docs.angularjs.org/error/$rootScope/infdig">&ldquo;<em>Inifite $diggest Loop Error</em>&rdquo; (<code>infdig</code>)</a> when used inside a <a href="https://docs.angularjs.org/api/ng/directive/ngRepeat"><code>ngRepeat</code> directive</a></li>
</ul>


<h3>The <code>$diggest</code> cycle always rings (at least) twice</h3>

<p>The <code>$diggest</code> cycle is the stage in which Angular ensures the changes of the model have settled,
so that it can render the view with the updated changes. In order to do that,
Angular starts a loop in which each iteration evaluates all the template expressions
of the view, as well as the <code>$watcher</code> functions of the <code>$scope</code>.
If in the current iteration the result is the same as the previous one,
then Angular will exit the loop. Otherwise, it will try again.
If after 10 attempts things haven&rsquo;t settled, Angular will exit
with an error: The <a href="https://docs.angularjs.org/error/$rootScope/infdig">&ldquo;<em>Inifite $diggest Loop Error</em>&rdquo; (<code>infdig</code>)</a>.</p>

<p>Despite this, it&rsquo;s still not obvious why the <code>$filter</code> is causing that error.
After all, the <code>$filter</code> passed the second unit test successfully:</p>

<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">it</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">should</span> <span class="nx">work</span> <span class="k">in</span> <span class="nx">a</span> <span class="nx">view</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">students</span> <span class="o">=</span> <span class="nx">students</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{{</span><span class="nx">students</span> <span class="o">|</span> <span class="nx">groupBy</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="kr">class</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;}}</span><span class="o">&lt;</span><span class="err">/p&gt;&amp;rdquo;);</span>
    <span class="nx">$compile</span><span class="p">(</span><span class="nx">elem</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">$scope</span><span class="p">)).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toThrow</span><span class="p">();</span>
  <span class="p">});</span></code></pre></div></p>

<p>This means that the <code>$diggest</code> cycle hasn&rsquo;t had any issues evaluating an Angular
Expression containing this <code>$filter</code>.</p>

<p>So, why is the <code>$filter</code> failing inside a <code>ngRepeat</code> directive?</p>

<p>It&rsquo;s because the <code>ngRepeat</code> directive adds a <code>$watch</code>er into its container&rsquo;s <code>$scope</code>
for the collection that&rsquo;s being iterated.
If <a href="https://github.com/angular/angular.js/blob/master/src/ng/directive/ngRepeat.js">we have a look at the code of the <code>ngRepeat</code> directive</a> we&rsquo;ll find a
line like this one:</p>

<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">$scope</span><span class="p">.</span><span class="nx">$watchCollection</span><span class="p">(</span><span class="nx">rhs</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">ngRepeatAction</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span><span class="o">&amp;</span><span class="nx">hellip</span><span class="p">;</span></code></pre></div></p>

<p>Which means that in our case, the <code>ngRepeat</code> directive is doing this, which is causing the error:</p>

<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">$scope</span><span class="p">.</span><span class="nx">$watchCollection</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">students</span> <span class="o">|</span> <span class="nx">groupBy</span><span class="o">:</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="kr">class</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;,</span> <span class="kd">function</span> <span class="nx">ngRepeatAction</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span><span class="o">&amp;</span><span class="nx">hellip</span><span class="p">;</span></code></pre></div></p>

<p>Since the <code>$filter</code> is returning a new <code>Object</code>
containing new <code>Arrays</code> every time it runs, this causes the <code>$diggest</code> cycle to get
into an infinite loop for the <code>$watchCollection</code> function.</p>

<p>So, I wrote a new test to make sure that was the source of problem:</p>

<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">it</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">should</span> <span class="nx">be</span> <span class="nx">able</span> <span class="nx">to</span> <span class="nx">$watchCollection</span> <span class="k">for</span> <span class="nx">an</span> <span class="nx">expression</span> <span class="nx">using</span> <span class="nx">the</span> <span class="nx">groupBy</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span>
  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">students</span> <span class="o">=</span> <span class="nx">students</span><span class="p">;</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">$watchCollection</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">students</span><span class="o">|</span><span class="nx">groupBy</span><span class="o">:&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="kr">class</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">collection</span><span class="p">){});</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">$scope</span><span class="p">)).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toThrow</span><span class="p">();</span>
  <span class="p">});</span></code></pre></div></p>

<p><a href="http://plnkr.co/edit/sRUSFy0FpmmSdC5NFm1f?p=preview">After running it</a>, I confirmed this test was also throwing the
<a href="https://docs.angularjs.org/error/$rootScope/infdig">&ldquo;<em>Inifite $diggest Loop Error</em>&rdquo; (<code>infdig</code>)</a>.</p>

<h2>The Solution(s)</h2>

<p>Before I implemented my solution I tried 2 different techniques for &ldquo;stabilizing&rdquo; the <code>$filter</code>:</p>

<ul>
<li>The first one (pretty bad in my opinion) is used by <a href="https://github.com/a8m">Ariel Mashraki (a8m)</a> which you can find <a href="https://github.com/a8m/angular-filter/blob/master/src/_filter/collection/group-by.js">here</a>.</li>
<li>The second one (much better) is the one that <a href="https://github.com/m59peacemaker">Johnny Hauser (m59peacemaker)</a> uses for stabilizing
his &ldquo;unstable&rdquo; <code>$filters</code>, which is this <a href="https://github.com/m59peacemaker/angular-pmkr-components/tree/master/src/services/filterStabilize">Filter Stabilizer</a> that relies on Memoization.</li>
</ul>


<p>Lets have a look at these 2 options.</p>

<h3>Ariel Mashraki&rsquo;s Solution</h3>

<p>His solution is equivalent to doing this:</p>

<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">groupBy</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">key</span><span class="p">)</span> <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">outputPropertyName</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="nx">groupBy</span><span class="o">&lt;</span><span class="err">/strong&gt;&amp;rsquo; + key;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">[</span><span class="nx">outputPropertyName</span><span class="p">]){</span>
            <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span><span class="o">&lt;</span><span class="nx">br</span><span class="o">/&gt;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]])</span>
                    <span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]]</span><span class="o">=</span><span class="p">[];</span>
                <span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]].</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">outputPropertyName</span><span class="p">,</span> <span class="p">{</span><span class="nx">enumerable</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="nx">configurable</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">writable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="nx">result</span><span class="p">});</span>
            <span class="nx">$timeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="k">delete</span> <span class="nx">data</span><span class="p">[</span><span class="nx">outputPropertyName</span><span class="p">];},</span><span class="mi">0</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">data</span><span class="p">[</span><span class="nx">outputPropertyName</span><span class="p">];</span>
    <span class="p">};</span>
<span class="p">})</span></code></pre></div></p>

<p>Basically what it&rsquo;s doing is creating a non-enumerable property in the original <code>Array</code>
that is being filtered with the result of the &lsquo;groupBy&rsquo;. In this way, when the <code>$diggest</code>
cycle triggers the <code>$filter</code>, the <code>$filter</code> will first check if the property has already been set.
If it hasn&rsquo;t, it will do the &lsquo;groupBy&rsquo; and will save the result in the non-enumerable property.
If the property has already been set, it will return the cached value. Also, notice that
there is a <code>$timeout</code> that deletes that property after the <code>$diggest</code> cycle has finished.</p>

<p>I must admit that this is a clever way to try to trick the <code>$diggest</code> cycle and that this <code>$filter</code>
would pass the unit tests. However, this <code>$filter</code> has an issue: it can&rsquo;t be
combined with other <code>$filter</code>s. For example, <a href="http://plnkr.co/edit/SSw0mKePtP8NvYNO00uO?p=preview">it wouldn&rsquo;t pass this test</a>:</p>

<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">it</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">should</span> <span class="nx">work</span> <span class="nx">inside</span> <span class="nx">an</span> <span class="nx">ngRepeat</span> <span class="k">in</span> <span class="nx">combination</span> <span class="kd">with</span> <span class="nx">other</span> <span class="nx">filters</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span>
      <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;&amp;</span><span class="nx">rdquo</span><span class="p">;</span> <span class="o">+</span>
       <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="nx">li</span> <span class="nx">ng</span><span class="o">-</span><span class="nx">repeat</span><span class="o">=</span><span class="err">\</span><span class="s2">&quot;(class, classStudents) in (students|filter:&#39;e&#39; | groupBy:&#39;class&#39;)\&quot;&gt;&amp;rdquo; +</span>
<span class="s2">          &amp;ldquo;{{class}}&amp;rdquo; +</span>
<span class="s2">          &amp;ldquo;&lt;ul&gt;&amp;rdquo; +</span>
<span class="s2">            &amp;ldquo;&lt;li ng-repeat=\&quot;student in classStudents\&quot;</span><span class="o">&gt;&amp;</span><span class="nx">rdquo</span><span class="p">;</span> <span class="o">+</span>
              <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;{{</span><span class="nx">student</span><span class="p">.</span><span class="nx">name</span><span class="p">}}</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;</span> <span class="o">+</span>
            <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/li&gt;&amp;rdquo; +</span>
          <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/ul&gt;&amp;rdquo; +</span>
        <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/li&gt;&amp;rdquo; +</span>
      <span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="o">&lt;</span><span class="err">/ul&gt;&amp;rdquo;);</span>
    <span class="nx">$compile</span><span class="p">(</span><span class="nx">elem</span><span class="p">)(</span><span class="nx">$scope</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">$scope</span><span class="p">)).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toThrow</span><span class="p">();</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">children</span><span class="p">().</span><span class="nx">children</span><span class="p">().</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="p">});</span></code></pre></div></p>

<h3>Johnny Hauser&rsquo;s &ldquo;Filter Stabilizer&rdquo; Solution</h3>

<p>I must say that this <a href="https://github.com/m59peacemaker/angular-pmkr-components/tree/master/src/services/filterStabilize">Filter Stabilizer</a> is <strong>awesome</strong> as a generic solution
for stabilizing <code>$filter</code>s, and that if it was used for the original filter, like this,
<a href="http://plnkr.co/edit/uAUE9g9STrMpsWc43vYO?p=preview">it would pass all the tests</a>:</p>

<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">pmkr</span><span class="p">.</span><span class="nx">filters</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;,</span> <span class="p">[])</span>
<span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">groupBy</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="p">[</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">pmkr</span><span class="p">.</span><span class="nx">filterStabilize</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stabilize</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">stabilize</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span> <span class="nx">key</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]])</span>
                <span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]]</span><span class="o">=</span><span class="p">[];</span>
            <span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]].</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}])</span>
<span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">pmkr</span><span class="p">.</span><span class="nx">filterStabilize</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="p">[</span>
  <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">pmkr</span><span class="p">.</span><span class="nx">memoize</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">memoize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">service</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">function</span> <span class="nx">filter</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
        <span class="c1">// always pass a copy of the args so that the original input can&amp;rsquo;t be modified</span>
        <span class="nx">args</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
        <span class="c1">// return the &lt;code&gt;fn&lt;/code&gt; return value or input reference (makes &lt;code&gt;fn&lt;/code&gt; return optional)</span>
        <span class="kd">var</span> <span class="nx">filtered</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="o">||</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">return</span> <span class="nx">filtered</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">memoized</span> <span class="o">=</span> <span class="nx">memoize</span><span class="p">(</span><span class="nx">filter</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">memoized</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">service</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">])</span>
<span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">pmkr</span><span class="p">.</span><span class="nx">memoize</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="p">[</span>
  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">service</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">memoizeFactory</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">memoizeFactory</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="kd">function</span> <span class="nx">memoized</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">fromCache</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">fromCache</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">fromCache</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">memoized</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">service</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">]);</span></code></pre></div></p>

<p>There is only one small inconvenience though: <strong>memory</strong>. If this technique is used
with a large <code>Array</code> of objects and many changes are made to it
(i.e. add/remove items and/or filter the Array before grouping it),
then, every time that the Array changes, the <code>memoizeFactory</code> will serialize it.
And it will then store that as the <code>key</code> of the cache used for &lsquo;memoizing&rsquo; the result of
the &lsquo;groupBy&rsquo; function.</p>

<p>I must admit in most cases that shouldn&rsquo;t be an issue, but
still, I don&rsquo;t want to have to worry about possible (although unlikely) memory leaks.</p>

<h3>My Solution</h3>

<p>This solution relies on the fact that the <code>ngRepeat</code> directive creates a new <code>$scope</code>,
the <code>$id</code> which can be used for identifying the cached result of the <code>$filter</code>. Also,
it&rsquo;s possible to listen for the <code>$destroy</code> event of that <code>$scope</code> to remove
its cached result in order to avoid memory leaks.</p>

<p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">sbrpr</span><span class="p">.</span><span class="nx">filters</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;,</span> <span class="p">[])</span>
<span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">groupBy</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">results</span><span class="o">=</span><span class="p">{};</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">data</span> <span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span> <span class="nx">key</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">$id</span><span class="p">){</span>
            <span class="nx">result</span><span class="o">=</span><span class="p">{};</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="kd">var</span> <span class="nx">scopeId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$id</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">[</span><span class="nx">scopeId</span><span class="p">]){</span>
                <span class="nx">results</span><span class="p">[</span><span class="nx">scopeId</span><span class="p">]</span><span class="o">=</span><span class="p">{};</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$on</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ldquo</span><span class="p">;</span><span class="nx">$destroy</span><span class="o">&amp;</span><span class="nx">rdquo</span><span class="p">;,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">delete</span> <span class="nx">results</span><span class="p">[</span><span class="nx">scopeId</span><span class="p">];</span>
                <span class="p">});</span>
            <span class="p">}</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="nx">scopeId</span><span class="p">];</span>
        <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>

<span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">groupKey</span> <span class="k">in</span> <span class="nx">result</span><span class="p">)</span>
      <span class="nx">result</span><span class="p">[</span><span class="nx">groupKey</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">result</span><span class="p">[</span><span class="nx">groupKey</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]])</span>
            <span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]]</span><span class="o">=</span><span class="p">[];</span>
        <span class="nx">result</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">key</span><span class="p">]].</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">k</span><span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">k</span><span class="o">++</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="nx">keys</span><span class="p">[</span><span class="nx">k</span><span class="p">]].</span><span class="nx">length</span><span class="o">===</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">delete</span> <span class="nx">result</span><span class="p">[</span><span class="nx">keys</span><span class="p">[</span><span class="nx">k</span><span class="p">]];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>
<span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>

<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span></code></pre></div></p>

<p>It <a href="http://plnkr.co/edit/Trr3dIEplKxODk4WpqTr?p=preview">passes all the tests</a>, and the only situation where this would fail would be if the <code>$filter</code> was used more than once
inside the same <code>$scope</code>, but I can&rsquo;t think of a single case where this would actually be a problem.</p>
]]></content>
  </entry>
  
</feed>
